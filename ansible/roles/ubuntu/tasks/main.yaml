- name: Update package cache and upgrade all packages (Ubuntu 24.04)
  apt:
    update_cache: yes
    upgrade: dist

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Configure static IP address
  copy:
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          eth0:
            dhcp4: false
            addresses:
              - {{ ansible_host }}/24
            routes:
              - to: default
                via: {{ gateway_ip }}
            nameservers:
              addresses:
                - 10.0.0.2
                - 10.0.0.3
    dest: /etc/netplan/99-eth0-static.yaml
    owner: root
    group: root
    mode: '0600'

- name: Install chrony for NTP synchronization
  apt:
    name: chrony
    state: present

- name: Configure chrony NTP settings
  copy:
    content: |
      # Public NTP pools
      pool 0.pool.ntp.org iburst
      pool 1.pool.ntp.org iburst
      pool 2.pool.ntp.org iburst
      pool 3.pool.ntp.org iburst
      
      # Preferred local NTP servers
      server 10.0.0.2 iburst prefer
      server 10.0.0.3 iburst prefer
      
      # Local stratum 10 fallback
      local stratum 10
      
      # Allow chrony to adjust frequency more aggressively
      maxslewrate 500
      
      # Increase polling range (reduce jitter once stable)
      minsources 2
      
      driftfile /var/lib/chrony/drift
      makestep 1.0 3
      rtcsync
      logdir /var/log/chrony
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: Ensure chronyd is enabled and started
  systemd:
    name: chronyd
    enabled: true
    state: started

- name: Install ufw firewall
  apt:
    name: ufw
    state: present

- name: Configure ufw
  ansible.builtin.shell: |
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow ssh
    ufw --force enable

- name: Install essential packages
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - apt-transport-https
    state: present

- name: Install step-cli
  ansible.builtin.shell: |
    apt-get update && apt-get install -y --no-install-recommends curl vim gpg ca-certificates
    curl -fsSL https://packages.smallstep.com/keys/apt/repo-signing-key.gpg -o /etc/apt/trusted.gpg.d/smallstep.asc && \
      echo 'deb [signed-by=/etc/apt/trusted.gpg.d/smallstep.asc] https://packages.smallstep.com/stable/debian debs main' \
      | tee /etc/apt/sources.list.d/smallstep.list
    apt-get update && apt-get -y install step-cli
  args:
    creates: /usr/bin/step

- name: Trust private CA certificate
  ansible.builtin.shell: |
    step ca bootstrap --ca-url https://ca.home.trankim.net --fingerprint d9fd2e6af8e00a2d06c066e0862ff449185b54c4bb1f76dff82bc1ecebeb7f56 --install
  args:
    creates: /usr/local/share/ca-certificates/Tran_Kim_Network_Root_CA_*.crt
