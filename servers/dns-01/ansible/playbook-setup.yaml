- name: Setup dns-01 server
  hosts: dns-01
  gather_facts: true
  become: true

  tasks:
    - name: Update package cache and upgrade all packages (Debian Trixie)
      apt:
        update_cache: yes
        upgrade: dist

    - name: set hostname
      hostname:
        name: dns-01

    - name: Configure static IP address
      copy:
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              eth0:
                dhcp4: false
                addresses:
                  - 10.0.0.2/24
                routes:
                  - to: default
                    via: 10.0.0.1
                nameservers:
                  addresses:
                    - 1.1.1.1
                    - 1.0.0.1
        dest: /etc/netplan/99-eth0-static.yaml
        owner: root
        group: root
        mode: '0600'

    - name: Install chrony for NTP synchronization
      apt:
        name: chrony
        state: present

    - name: Configure chrony NTP settings
      copy:
        content: |
          # NTP server configuration for dns-01
          server 0.pool.ntp.org iburst
          server 1.pool.ntp.org iburst
          server 2.pool.ntp.org iburst
          server 3.pool.ntp.org iburst
          server 10.0.0.2 noselect
          server 10.0.0.3 noselect
          
          # Allow clients to sync with this server
          allow 10.0.0.0/8
          
          # Local stratum 10 fallback
          local stratum 10
          
          # Allow chrony to adjust frequency more aggressively
          maxslewrate 500
          
          # Increase polling range (reduce jitter once stable)
          minsources 2
          
          driftfile /var/lib/chrony/drift
          makestep 1.0 3
          rtcsync
          logdir /var/log/chrony
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: Ensure chronyd is enabled and started
      systemd:
        name: chronyd
        enabled: true
        state: started

    - name: Install ufw firewall
      apt:
        name: ufw
        state: present

    - name: Configure ufw
      ansible.builtin.shell: |
        ufw default deny incoming
        ufw default allow outgoing
        ufw allow ssh
        ufw allow 53/tcp
        ufw allow 53/udp
        ufw allow 443/tcp
        ufw allow 80/tcp
        ufw allow 9100/tcp
        ufw allow 123/udp
        ufw --force enable

    - name: Install required packages for Docker
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - apt-transport-https
        state: present

    - name: Add Docker's official GPG key and set up apt repository
      ansible.builtin.shell: |
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc

        sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
        Types: deb
        URIs: https://download.docker.com/linux/debian
        Suites: $(. /etc/os-release && echo "$VERSION_CODENAME")
        Components: stable
        Signed-By: /etc/apt/keyrings/docker.asc
        EOF
        
        sudo apt update
      args:
        creates: /etc/apt/keyrings/docker.asc, /etc/apt/sources.list.d/docker.sources

    - name: Install Docker Engine
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: latest
        update_cache: yes

    - name: Add current user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: true
        state: started

    - name: Create group for dns
      group:
        name: dns
        gid: 1001

    - name: create user for dns
      user:
        name: dns
        uid: 1001
        shell: /bin/bash
        create_home: false
        groups: dns

    - name: Create group for ca
      group:
        name: ca
        gid: 1002

    - name: create user for ca
      user:
        name: ca
        uid: 1002
        shell: /bin/bash
        create_home: true
        groups: ca

    - name: Install step-cli
      ansible.builtin.shell: |
        apt-get update && apt-get install -y --no-install-recommends curl vim gpg ca-certificates
        curl -fsSL https://packages.smallstep.com/keys/apt/repo-signing-key.gpg -o /etc/apt/trusted.gpg.d/smallstep.asc && \
          echo 'deb [signed-by=/etc/apt/trusted.gpg.d/smallstep.asc] https://packages.smallstep.com/stable/debian debs main' \
          | tee /etc/apt/sources.list.d/smallstep.list
        apt-get update && apt-get -y install step-cli
